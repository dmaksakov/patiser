user root;
worker_processes  1;

events {
  worker_connections  2048;
  multi_accept on;
  use epoll;
}

http {
    include /etc/nginx/mime.types;
    default_type  application/octet-stream;
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                        '$status $body_bytes_sent "$http_referer" '
                        '"$http_user_agent" "$http_x_forwarded_for"';
    access_log  /var/log/nginx/access.log  main;
    sendfile        on;
    keepalive_timeout  65;

    server {
      listen       80;
      server_name  localhost;

      #Gzip Config
      gzip on;
      gzip_http_version 1.1;
      gzip_vary on;
      gzip_comp_level 6;
      gzip_proxied any;
      gzip_buffers 16 8k;
      gzip_types text/plain application/xml application/json application/javascript application/x-javascript text/javascript text/xml text/css;

      # Disable gzip for certain browsers.
      gzip_disable “MSIE [1-6].(?!.*SV1)”;

      # security headers
      add_header X-Frame-Options "SAMEORIGIN" always;
      add_header X-XSS-Protection "1; mode=block" always;
      add_header X-Content-Type-Options "nosniff" always;
      add_header Referrer-Policy "no-referrer-when-downgrade" always;
      add_header Content-Security-Policy "default-src * data: 'unsafe-eval' 'unsafe-inline'" always;
      add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

	    root   /www;
      index index.html;

      location / {
      }

      location /client {
            try_files $uri $uri/ /client/index.html;
      }

      location ~ (index.html)$ {
          # kill cache
          add_header Last-Modified $date_gmt;
          add_header Cache-Control 'no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0';
          if_modified_since off;
          expires off;
          etag off;
          proxy_no_cache 1;
      }

      location ~* (service-worker\.js)$ {
          add_header 'Cache-Control' 'no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0';
          expires off;
          proxy_no_cache 1;
      }
            
      location ~* (manifest\.json)$ {
        expires 1h;
        add_header Cache-Control "public";
      }

      location ~* ^.+\.(jpg|jpeg|gif|png|ico|svg|css|zip|tgz|gz|rar|bz2|exe|pdf|doc|xls|ppt|txt|odt|ods|odp|odf|tar|bmp|rtf|js|mp3|avi|mpeg|flv|html|htm)$ {
          expires max;
          try_files $uri =404;
      }


      # redirect server error pages to the static page /50x.html
      #
      error_page   500 502 503 504  /50x.html;
      location = /50x.html {
        root   /www;
      }

      location /health_check {
        return 200 "Healthy\n";
      }

    }
}
